{% extends "base.html" %}
{% block title %}店舗一覧 | NAGOYAMESHI{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0">
    {% if prefecture %}
    {{ prefecture }} の店舗一覧
    {% else %}
    店舗一覧
    {% endif %}
  </h1>
  <a href="{% url 'restaurants:prefecture_select' %}" class="btn btn-outline-secondary">
    <i class="bi bi-arrow-left"></i> 都道府県選択に戻る
  </a>
</div>

<!-- ▼ 検索・絞り込み・並び替えフォーム ▼ -->
<form method="get" class="row g-2 mb-4">
  <!-- 都道府県を保持 -->
  {% if prefecture %}
  <input type="hidden" name="prefecture" value="{{ prefecture }}">
  {% endif %}

  <!-- 店舗名検索 -->
  <div class="col-md-3">
    <label class="form-label">店舗名</label>
    <input type="text" name="keyword" class="form-control" placeholder="店舗名で検索" value="{{ keyword }}">
  </div>

  <!-- カテゴリ選択（名前で絞り込み） -->
  <div class="col-md-3">
    <label class="form-label">カテゴリ</label>
    <select name="category_name" class="form-select">
      <option value="">すべて</option>
      {% for category_name in category_names %}
      <option value="{{ category_name }}" {% if category_name==request.GET.category_name %}selected{% endif %}>
        {{ category_name }}
      </option>
      {% endfor %}
    </select>
  </div>

  <!-- 並び替え -->
  <div class="col-md-3">
    <label class="form-label">並び替え</label>
    <select name="sort" class="form-select">
      <option value="default" {% if sort=="default" %}selected{% endif %}>新しい順</option>
      <option value="price_low" {% if sort=="price_low" %}selected{% endif %}>価格が安い順</option>
      <option value="price_high" {% if sort=="price_high" %}selected{% endif %}>価格が高い順</option>
    </select>
  </div>

  <div class="col-md-3 d-flex align-items-end">
    <button type="submit" class="btn btn-primary me-2">検索</button>
    <a href="{% url 'restaurants:prefecture_select' %}" class="btn btn-outline-secondary">
      クリア
    </a>
  </div>
</form>
<!-- ▲ フィルタフォームここまで ▲ -->
{# ==== 店舗カード一覧 ==== #}
<div class="row g-4">
  {% for restaurant in restaurants %}
  <div class="col-md-4 col-sm-6">
    <div class="card h-100 shadow-sm">
      {% if restaurant.image %}
      <img src="{{ restaurant.image.url }}" class="card-img-top" alt="{{ restaurant.name }}">
      {% endif %}

      <div class="card-body">
        <h5 class="card-title">{{ restaurant.name }}</h5>
        <p class="card-text small text-muted mb-1">
          {{ restaurant.category.name }} / {{ restaurant.address }}
        </p>
        <p class="card-text small mb-2">
          営業時間: {{ restaurant.open_time }}〜{{ restaurant.close_time }}
        </p>

        <p class="mb-1 text-muted small" id="favorite-count-{{ restaurant.pk }}">
          お気に入り <span class="favorite-count">{{ restaurant.favorite_count|default:0 }}</span> 件
        </p>

        {% if user.is_authenticated %}
        <button
          class="btn btn-sm favorite-btn {% if restaurant.is_favorited %}btn-warning{% else %}btn-outline-primary{% endif %} me-2"
          data-restaurant-id="{{ restaurant.pk }}" data-is-favorited="{{ restaurant.is_favorited|yesno:'true,false' }}"
          onclick="toggleFavorite(this, {{ restaurant.pk }})">
          <span class="favorite-icon">{% if restaurant.is_favorited %}★{% else %}☆{% endif %}</span>
          <span class="favorite-text">{% if restaurant.is_favorited %}解除{% else %}お気に入り{% endif %}</span>
        </button>
        {% endif %}

        <a href="{% url 'restaurants:restaurant_detail' restaurant.pk %}" class="btn btn-primary btn-sm">
          詳細を見る
        </a>
      </div>
    </div>
  </div>
  {% empty %}
  <p>このカテゴリにはまだ店舗がありません。</p>
  {% endfor %}
</div>

<script>
  function toggleFavorite(button, restaurantId) {
    // CSRFトークンを取得
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken');

    // ボタンを一時的に無効化
    button.disabled = true;

    // お気に入り切り替えAPIを呼び出し
    fetch(`/favorite/${restaurantId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin'
    })
      .then(response => {
        if (response.redirected) {
          // 有料会員でない場合はリダイレクト
          window.location.href = response.url;
          return;
        }
        return response.json();
      })
      .then(data => {
        if (data && data.success) {
          // お気に入り状態を切り替え
          const isFavorited = data.is_favorited;
          const icon = button.querySelector('.favorite-icon');
          const text = button.querySelector('.favorite-text');
          const countElement = document.querySelector(`#favorite-count-${restaurantId} .favorite-count`);

          if (isFavorited) {
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-warning');
            icon.textContent = '★';
            text.textContent = '解除';
          } else {
            button.classList.remove('btn-warning');
            button.classList.add('btn-outline-primary');
            icon.textContent = '☆';
            text.textContent = 'お気に入り';
          }

          // お気に入り件数を更新
          if (countElement && data.favorite_count !== undefined) {
            countElement.textContent = data.favorite_count;
          }

          button.dataset.isFavorited = isFavorited;
        }

        // ボタンを再度有効化
        button.disabled = false;
      })
      .catch(error => {
        console.error('Error:', error);
        alert('エラーが発生しました。もう一度お試しください。');
        button.disabled = false;
      });
  }

  // CSRFトークンを取得する関数
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>

{% csrf_token %}
{% endblock %}