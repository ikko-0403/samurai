{% extends "base.html" %}
{% block title %}åº—èˆ—ä¸€è¦§ | NAGOYAMESHI{% endblock %}

{% block content %}
<h1 class="mb-4 text-center">ğŸ½ï¸ NAGOYAMESHI</h1>

<div class="search-container">
  {% if request.GET %}
  <form method="get" class="row g-2 mb-4">
  {% else %}
  <form method="get" class="search-form-large mb-5">
    <h3 class="text-center mb-4">ãŠåº—ã‚’æ¤œç´¢</h3>
  {% endif %}
  
    <div class="{% if request.GET %}col-md-2{% else %}search-field{% endif %}">
      <label class="form-label">éƒ½é“åºœçœŒ</label>
      <select name="prefecture" class="form-select" id="prefectureSelect">
        <option value="">ã™ã¹ã¦</option>
        {% for pref in prefectures %}
        <option value="{{ pref }}" {% if pref == prefecture %}selected{% endif %}>{{ pref }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="{% if request.GET %}col-md-2{% else %}search-field{% endif %}">
      <label class="form-label">å¸‚åŒºç”ºæ‘</label>
      <select name="city" id="citySelect" class="form-select">
        <option value="">ã™ã¹ã¦</option>
      </select>
    </div>

    <div class="{% if request.GET %}col-md-2{% else %}search-field{% endif %}">
      <label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label>
      <select name="category_name" class="form-select">
        <option value="">ã™ã¹ã¦</option>
        {% for category_name in category_names %}
        <option value="{{ category_name }}" {% if category_name == request.GET.category_name %}selected{% endif %}>{{ category_name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="{% if request.GET %}col-md-2{% else %}search-field{% endif %}">
      <label class="form-label">åº—èˆ—å</label>
      <input type="text" name="keyword" class="form-control" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢" value="{{ keyword }}">
    </div>

    {% if request.GET %}
    <div class="col-md-2">
      <label class="form-label">ä¸¦ã³æ›¿ãˆ</label>
      <select name="sort" class="form-select">
        <option value="default" {% if sort == "default" %}selected{% endif %}>æ–°ã—ã„é †</option>
        <option value="price_low" {% if sort == "price_low" %}selected{% endif %}>ä¾¡æ ¼ãŒå®‰ã„é †</option>
        <option value="price_high" {% if sort == "price_high" %}selected{% endif %}>ä¾¡æ ¼ãŒé«˜ã„é †</option>
      </select>
    </div>
    {% endif %}

    <div class="{% if request.GET %}col-md-2 d-flex align-items-end{% else %}search-buttons{% endif %}">
      <button type="submit" class="btn btn-primary {% if not request.GET %}btn-lg w-100{% else %}me-2{% endif %}">ğŸ” æ¤œç´¢</button>
      {% if request.GET %}
      <a href="{% url 'restaurants:restaurant_list' %}" class="btn btn-outline-secondary">ã‚¯ãƒªã‚¢</a>
      {% endif %}
    </div>
  </form>
</div>

{% if restaurants %}
<div class="restaurant-list">
  {% for restaurant in restaurants %}
  <div class="restaurant-card-horizontal mb-4">
    <div class="restaurant-image">
      {% if restaurant.image %}
      <img src="{{ restaurant.image.url }}" alt="{{ restaurant.name }}">
      {% else %}
      <div class="no-image">ç”»åƒãªã—</div>
      {% endif %}
    </div>
    <div class="restaurant-info">
      <h3 class="restaurant-name">
        <a href="{% url 'restaurants:restaurant_detail' restaurant.pk %}">{{ restaurant.name }}</a>
      </h3>
      <p class="restaurant-category">
        <span class="badge bg-secondary">{{ restaurant.category.name }}</span>
        {% if restaurant.prefecture %}<span class="ms-2 text-muted">ğŸ“ {{ restaurant.prefecture }} {% if restaurant.city %}{{ restaurant.city }}{% endif %}</span>{% endif %}
      </p>
      {% if restaurant.description %}
      <p class="restaurant-description">{{ restaurant.description|truncatewords:30 }}</p>
      {% endif %}
      <div class="restaurant-meta">
        {% if restaurant.price_min %}<span class="price">ğŸ’° Â¥{{ restaurant.price_min }}ã€œ</span>{% endif %}
        <span class="favorite-count ms-3">â¤ï¸ {{ restaurant.favorite_count|default:0 }}</span>
      </div>
    </div>
  </div>
  {% endfor %}
</div>
{% elif request.GET %}
<div class="text-center py-5">
  <h4>ğŸ˜” æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</h4>
  <p class="text-muted">åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„æ¡ä»¶ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>
  <a href="{% url 'restaurants:restaurant_list' %}" class="btn btn-primary">æ¤œç´¢æ¡ä»¶ã‚’ã‚¯ãƒªã‚¢</a>
</div>
{% else %}
<div class="text-center py-5">
  <h3 class="text-muted">ä¸Šè¨˜ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ãŠåº—ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„</h3>
  <p class="text-muted">éƒ½é“åºœçœŒã€å¸‚åŒºç”ºæ‘ã€ã‚«ãƒ†ã‚´ãƒªã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰æ¤œç´¢ã§ãã¾ã™ã€‚</p>
</div>
{% endif %}

<style>
  .search-container { max-width: 1200px; margin: 0 auto 40px; }
  .search-form-large { background: #f8f9fa; padding: 40px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
  .search-field { margin-bottom: 20px; }
  .search-buttons { margin-top: 10px; }
  .restaurant-list { max-width: 1000px; margin: 0 auto; }
  .restaurant-card-horizontal { display: flex; border: 1px solid #dee2e6; border-radius: 12px; overflow: hidden; background: white; transition: box-shadow 0.3s ease, transform 0.2s ease; }
  .restaurant-card-horizontal:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.12); transform: translateY(-2px); }
  .restaurant-image { width: 300px; height: 200px; flex-shrink: 0; background: #f8f9fa; display: flex; align-items: center; justify-content: center; }
  .restaurant-image img { width: 100%; height: 100%; object-fit: cover; }
  .restaurant-image .no-image { color: #6c757d; font-size: 14px; }
  .restaurant-info { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
  .restaurant-name { font-size: 1.5rem; margin: 0; font-weight: 600; }
  .restaurant-name a { color: #212529; text-decoration: none; transition: color 0.2s; }
  .restaurant-name a:hover { color: #0d6efd; }
  .restaurant-category { margin: 0; }
  .restaurant-description { color: #6c757d; margin: 0; font-size: 0.95rem; line-height: 1.6; }
  .restaurant-meta { display: flex; align-items: center; margin-top: auto; font-size: 0.9rem; color: #495057; }
  @media (max-width: 768px) {
    .restaurant-card-horizontal { flex-direction: column; }
    .restaurant-image { width: 100%; height: 180px; }
    .search-form-large { padding: 20px; }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const prefectureSelect = document.getElementById('prefectureSelect');
    const citySelect = document.getElementById('citySelect');
    
    if (prefectureSelect) {
      prefectureSelect.addEventListener('change', function() {
        const prefecture = this.value;
        citySelect.innerHTML = '<option value="">ã™ã¹ã¦</option>';
        
        if (prefecture) {
          fetch(`/api/cities/?prefecture=${encodeURIComponent(prefecture)}`)
            .then(response => response.json())
            .then(data => {
              if (data.cities && data.cities.length > 0) {
                data.cities.forEach(city => {
                  const option = document.createElement('option');
                  option.value = city;
                  option.textContent = city;
                  citySelect.appendChild(option);
                });
              }
            })
            .catch(error => console.error('Error:', error));
        }
      });
    }
  });
</script>
{% endblock %}
