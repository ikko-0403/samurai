{% extends "base.html" %}
{% block title %}お気に入り一覧 | NAGOYAMESHI{% endblock %}

{% block content %}
<div class="container my-4">
  <h1 class="h3 mb-4">
    <i class="bi bi-heart-fill text-danger"></i> お気に入り店舗一覧
  </h1>

  {% if restaurants %}
  <p class="text-muted mb-4">{{ restaurants|length }} 件の店舗をお気に入り登録しています</p>

  <div class="row g-4">
    {% for restaurant in restaurants %}
    <div class="col-md-6 col-lg-4">
      <div class="card h-100 shadow-sm">
        {% if restaurant.image %}
        <img src="{{ restaurant.image.url }}" class="card-img-top" alt="{{ restaurant.name }}"
          style="height: 200px; object-fit: cover;">
        {% else %}
        <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center text-white"
          style="height: 200px;">
          <i class="bi bi-image" style="font-size: 3rem;"></i>
        </div>
        {% endif %}

        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ restaurant.name }}</h5>

          <p class="card-text small text-muted mb-2">
            <i class="bi bi-tag"></i> {{ restaurant.category.name }}
          </p>

          <p class="card-text small text-muted mb-2">
            <i class="bi bi-geo-alt"></i> {{ restaurant.address }}
          </p>

          <p class="card-text small mb-2">
            <i class="bi bi-clock"></i> {{ restaurant.open_time }} 〜 {{ restaurant.close_time }}
          </p>

          <div class="mb-2">
            {% if restaurant.avg_rating %}
            <span class="badge bg-warning text-dark">
              ★ {{ restaurant.avg_rating|floatformat:1 }}
            </span>
            {% endif %}
            <span class="small text-muted">({{ restaurant.review_count }} 件のレビュー)</span>
          </div>

          <p class="small text-muted mb-3" id="favorite-count-{{ restaurant.pk }}">
            <i class="bi bi-heart"></i> <span class="favorite-count">{{ restaurant.favorite_count }}</span> 件のお気に入り
          </p>

          <div class="mt-auto">
            <button class="btn btn-sm btn-warning me-2 favorite-btn" data-restaurant-id="{{ restaurant.pk }}"
              data-is-favorited="true" onclick="toggleFavorite(this, {{ restaurant.pk }})">
              <i class="bi bi-heart-fill"></i> お気に入り解除
            </button>

            <a href="{% url 'restaurants:restaurant_detail' restaurant.pk %}" class="btn btn-sm btn-primary">
              <i class="bi bi-arrow-right-circle"></i> 詳細を見る
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info" role="alert">
    <h4 class="alert-heading">
      <i class="bi bi-info-circle"></i> お気に入りはまだありません
    </h4>
    <p>気になる店舗を見つけたら、ハートマーク ❤️ をクリックしてお気に入りに追加しましょう！</p>
    <hr>
    <p class="mb-0">
      <a href="{% url 'restaurants:restaurant_list' %}" class="btn btn-primary">
        <i class="bi bi-search"></i> 店舗を探す
      </a>
    </p>
  </div>
  {% endif %}
</div>

<script>
  function toggleFavorite(button, restaurantId) {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken');

    button.disabled = true;

    fetch(`/favorite/${restaurantId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin'
    })
      .then(response => {
        if (response.redirected) {
          window.location.href = response.url;
          return;
        }
        return response.json();
      })
      .then(data => {
        if (data && data.success) {
          if (!data.is_favorited) {
            // お気に入り解除されたのでカードを削除
            const card = button.closest('.col-md-6');
            card.remove();

            // 全てのカードがなくなったらメッセージを表示
            const remainingCards = document.querySelectorAll('.row.g-4 .col-md-6');
            if (remainingCards.length === 0) {
              location.reload();
            }
          }
        }
        button.disabled = false;
      })
      .catch(error => {
        console.error('Error:', error);
        alert('エラーが発生しました。もう一度お試しください。');
        button.disabled = false;
      });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>

{% csrf_token %}
{% endblock %}